<!DOCTYPE html>
<html>
<head>
    <title>Загрузка файла</title>
    <style>
        #progress-container {
            display: none;
            margin-top: 20px;
        }

        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            transition: width 0.3s;
        }

        #progress-text {
            margin-top: 10px;
        }

        table {
            margin-top: 20px;
            border-collapse: collapse;
            width: 100%;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 8px;
        }

        #pagination {
            margin-top: 10px;
        }

        #pagination button {
            margin-right: 5px;
        }

        #auth-section, #unauth-section {
            display: none;
        }
    </style>
</head>
<body>
<div id="unauth-section">
    <button id="status-btn">Статус</button>
    <button id="version-btn">Версия</button>
    <button id="metrics-btn">Метрики</button>

    <hr>

    <h2>Вход в систему</h2>
    <form id="login-form">
        <input type="text" name="username" placeholder="Имя пользователя" required>
        <input type="password" name="password" placeholder="Пароль" required>
        <button type="submit">Войти</button>
    </form>
    <p id="login-status"></p>
</div>

<div id="auth-section">
    <button id="logout-btn">Выйти</button>
    <button id="change-password-btn">Сменить пароль</button>

    <hr>

    <h2>Загрузите текстовый файл</h2>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="file" accept=".txt" required>
        <button type="submit">Загрузить</button>
    </form>

    <div id="progress-container">
        <div id="progress-bar"></div>
        <p id="progress-text">Ожидание...</p>
    </div>

    <div id="result-section" style="display: none;">
        <h3>Результаты анализа</h3>
        <table id="result-table">
            <thead>
            <tr>
                <th>Слово</th>
                <th>TF</th>
                <th>IDF</th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="pagination">
            <button id="prev-page-btn">Назад</button>
            <span id="page-info"></span>
            <button id="next-page-btn">Вперёд</button>
        </div>
    </div>
</div>

<script>
    const loginForm = document.getElementById("login-form");
    const logoutBtn = document.getElementById("logout-btn");
    const changePasswordBtn = document.getElementById("change-password-btn");
    const statusBtn = document.getElementById("status-btn");
    const versionBtn = document.getElementById("version-btn");
    const metricsBtn = document.getElementById("metrics-btn");
    const authSection = document.getElementById("auth-section");
    const unauthSection = document.getElementById("unauth-section");
    const loginStatus = document.getElementById("login-status");

    let accessToken = localStorage.getItem("access_token");

    function updateUI() {
        if (accessToken) {
            authSection.style.display = "block";
            unauthSection.style.display = "none";
        } else {
            authSection.style.display = "none";
            unauthSection.style.display = "block";
        }
    }

    loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(loginForm);
        const payload = new URLSearchParams(formData);

        try {
            const res = await fetch("/api/v2/user/login", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: payload
            });

            if (!res.ok) {
                loginStatus.textContent = "Ошибка входа.";
                return;
            }

            const data = await res.json();
            accessToken = data.access_token;
            localStorage.setItem("access_token", accessToken);
            loginStatus.textContent = "Успешный вход!";
            updateUI();
        } catch (err) {
            loginStatus.textContent = "Ошибка запроса.";
            console.error(err);
        }
    });

    logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("access_token");
        accessToken = null;
        updateUI();
    });

    statusBtn.addEventListener("click", async () => {
        const res = await fetch("/api/v2/status");
        const data = await res.json();
        alert(`Статус: ${data.status}`);
    });

    versionBtn.addEventListener("click", async () => {
        const res = await fetch("/api/v2/version");
        const data = await res.json();
        alert(`Версия: ${data.version}`);
    });

    metricsBtn.addEventListener("click", async () => {
        const res = await fetch("/api/v2/metrics");
        const data = await res.json();
        alert(`Метрики: ${JSON.stringify(data)}`);
    });

    updateUI();
</script>
</body>
</html>
